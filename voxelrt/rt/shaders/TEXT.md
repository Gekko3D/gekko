# Text Overlay Render Shader (text.wgsl)

This document describes the simple text overlay shader used to draw HUD/debug text on top of the final image.

Related
- RENDERER.md — pass ordering (Text is drawn last, after Particles)
- rt/app/app.go — font atlas creation, buffer updates, pipeline and bind groups setup

## Responsibilities

- Render prebuilt quads for glyphs using a single-channel font atlas.
- Modulate atlas coverage with per-vertex color to draw crisp UI text.

This pass uses the swapchain render target (same as fullscreen blit and particles), and does not write depth.

## Bindings and Data

Bind Group 0
- binding(0): t_diffuse: texture_2d<f32>
  - Single-channel font atlas (R8) uploaded by the App from TextRenderer.
- binding(1): s_diffuse: sampler
  - Linear sampler for the atlas.

Vertex attributes (per-vertex)
- location(0): pos: vec2<f32>
  - Clip-space position [-1,1] already precomputed by the CPU.
- location(1): uv: vec2<f32>
  - Texture coordinates into the atlas.
- location(2): color: vec4<f32>
  - Per-glyph color (RGBA 0..1). Alpha is combined with atlas coverage.

Notes
- The pipeline and bind group are created in rt/app/app.go (setupTextResources).
- Vertex buffer layout matches core.TextVertex generated by TextRenderer.

## Vertex Stage

- Pass-through transform; positions provided are already in clip space:
  - out.clip_pos = vec4(pos, 0, 1)
- Forwards uv and color to the fragment stage unchanged.

Rationale
- CPU computes glyph quads in clip space based on window resolution and desired screen position/scale. This keeps the shader trivial and avoids per-vertex matrix multiplication.

## Fragment Stage

- Sample the font atlas at in.uv:
  - tex_color.r is the coverage of the glyph at that pixel.
- Compose output color:
  - out = vec4(color.rgb, color.a * tex_color.r)

This multiplies the user-provided alpha by the atlas coverage so glyph shapes are correctly masked. The RGB is not premultiplied here; blending settings in the text pipeline (SrcAlpha/OneMinusSrcAlpha) handle transparency.

## Ordering

- Executed after:
  - G-Buffer, Shadows, Deferred Lighting, optional Debug, Fullscreen blit, Particles billboard
- Drawn last to ensure legible text over the final composed image.

## Tuning Tips

- Font size/scale:
  - Controlled when building vertices in the TextRenderer; shader is resolution-agnostic.
- Sampling:
  - Linear sampling provides smoother edges; for sharper text, consider nearest sampling on an atlas generated for screen resolution.
- Color:
  - Using white atlas with colored vertices keeps asset size small and allows arbitrary tinting.

## Common Issues

- Blurry text:
  - Check atlas resolution and sampling mode; ensure UVs align with texel centers if using nearest.
- Incorrect alpha:
  - Verify the text pipeline’s blend state is SrcAlpha/OneMinusSrcAlpha and that fragment alpha = color.a * coverage.

## Future Improvements

- Signed distance field (SDF) atlas to scale text cleanly at multiple sizes.
- Subpixel rendering for improved readability on LCD displays.
- Drop shadow/outline by offset sampling of the atlas.
- Dynamic atlas paging and caching for large character sets.
